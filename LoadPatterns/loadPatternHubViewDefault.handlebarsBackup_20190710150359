--
-- Hub View definition for {{mainTable}}
-- Generated at {{generationDateTime}}
--

USE [{{metadataConfiguration.psaDatabaseName}}]
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[{{metadataConfiguration.vedwSchemaName}}].[{{mainTable}}]') AND type in (N'V'))
DROP VIEW [{{metadataConfiguration.vedwSchemaName}}].[{{mainTable}}]
GO
CREATE VIEW [{{metadataConfiguration.vedwSchemaName}}].[{{mainTable}}] AS

SELECT hub.*
FROM (
{{#each individualSourceToTargetMapping }}
    SELECT
        {{#each businessKey.businessKeyComponentMapping}}
        CONVERT(NVARCHAR(100),[{{sourceComponentName}}]) AS [{{targetComponentName}}],
        {{/each}}
        {{../metadataConfiguration.recordSourceAttribute}},
        MIN({{../metadataConfiguration.loadDateTimeAttribute}}) AS {{../metadataConfiguration.loadDateTimeAttribute}}
    FROM {{sourceTable}} 
    WHERE
        {{#each businessKey.businessKeyComponentMapping}}
        [{{sourceComponentName}}]) IS NOT NULL {{/each}} {{#if filterCriterion}}AND {{filterCriterion}}{{/if}}
    GROUP BY
        {{#each businessKey.businessKeyComponentMapping}}
        [{{sourceComponentName}}],
        {{/each}}
        {{../metadataConfiguration.recordSourceAttribute}}
    {{#unless @last}}UNION{{/unless}}
{{/each}}
) hub