{{#each individualSourceToTargetMapping }}
--
-- Working on mapping to {{targetTable}} from source table {{sourceTable}}
--

SELECT
    HASHBYTES('MD5',
    {{#each businessKey.businessKeyComponentMapping}}
      ISNULL(RTRIM(CONVERT(NVARCHAR(100), {{targetComponentName}})), 'N/A') + '#~!' {{#unless @last}}+{{/unless}}
    {{/each}}
    ) AS {{targetTableHashKey}},
    {{#each businessKey.businessKeyComponentMapping}}
      {{targetComponentName}},
    {{/each}}
    MIN(stg.LOAD_DATETIME) AS LOAD_DATETIME,
    -1 AS ETL_INSERT_RUN_ID,
    stg.RECORD_SOURCE
FROM {{sourceTable}} stg
LEFT OUTER JOIN [200_Integration_Layer].dbo.{{targetTable}} hub ON
    {{#each businessKey.businessKeyComponentMapping}}
    stg.{{sourceComponentName}} = hub.{{targetComponentName}} {{#unless @last}}AND{{/unless}}
    {{/each}}
 WHERE
    {{#each businessKey.businessKeyComponentMapping}}
    {{sourceComponentName}} IS NOT NULL AND hub.{{targetComponentName}} IS NOT NULL {{#unless @last}}AND{{/unless}}
    {{/each}}
GROUP BY
    HASHBYTES('MD5',
    {{#each businessKey.businessKeyComponentMapping}}
      ISNULL(RTRIM(CONVERT(NVARCHAR(100), {{targetComponentName}})), 'N/A') + '#~!'
    {{/each}}
    ),
    {{#each businessKey.businessKeyComponentMapping}}
    {{sourceComponentName}},
    {{/each}}
    stg.RECORD_SOURCE

{{/each}}

